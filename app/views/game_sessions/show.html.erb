<h1><%= @game_session.name %></h1>

<script>
  let gameChannel = null;
  
  function initializeActionCable() {
    if (window.App && window.App.cable) {
      const gameSessionId = <%= @game_session.id %>;
      
      gameChannel = window.App.cable.subscriptions.create(
        { 
          channel: "GameChannel", 
          game_session_id: gameSessionId 
        },
        {
          connected: function() {
            console.log(`Connected to GameChannel for session ${gameSessionId}`);
          },

          disconnected: function() {
            console.log('Disconnected from GameChannel');
          },

          received: function(data) {
            console.log('Received game update:', data);
            handleGameUpdate(data);
          }
        }
      );
    } else {
      console.error('Action Cable not available, retrying in 1 second...');
      setTimeout(initializeActionCable, 1000);
    }
  }
  
  document.addEventListener('DOMContentLoaded', function() {
    // ActionCableの初期化を少し遅らせる
    setTimeout(initializeActionCable, 500);
  });
  
  function handleGameUpdate(data) {
    console.log('Handling update:', data.type);
    
    // 通知を表示
    if (data.message) {
      showNotification(data.message);
    }
    
    // タイプに応じて処理
    switch(data.type) {
      case 'player_action':
        if (data.current_player_name) {
          updateCurrentTurn(data.current_player_name, data.current_player_id);
        }
        // ページをリロード（簡易版）
        setTimeout(() => {
          location.reload();
        }, 2000);
        break;
        
      case 'game_status':
        if (data.status === 'finished' && data.winner) {
          showWinnerModal(data.winner);
        } else if (data.status === 'playing') {
          setTimeout(() => {
            location.reload();
          }, 1000);
        }
        break;
        
      case 'player_joined':
      case 'player_left':
        setTimeout(() => {
          location.reload();
        }, 1000);
        break;
    }
  }
  
  function updateCurrentTurn(playerName, playerId) {
    const currentUserId = document.body.dataset.currentUserId;
    const turnMessage = document.querySelector('.current-turn-message');
    
    if (turnMessage) {
      if (playerId == currentUserId) {
        turnMessage.innerHTML = '<div class="alert alert-success">あなたのターンです！</div>';
      } else {
        turnMessage.innerHTML = `<div class="alert alert-info">${playerName}さんのターンです。お待ちください。</div>`;
      }
    }
  }
  
  function showNotification(message) {
    // 既存の通知を削除
    const existingNotifications = document.querySelectorAll('.game-notification');
    existingNotifications.forEach(n => n.remove());
    
    // 新しい通知を作成
    const notification = document.createElement('div');
    notification.className = 'alert alert-info alert-dismissible fade show position-fixed game-notification';
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; max-width: 400px;';
    notification.innerHTML = `
      <i class="fas fa-info-circle me-2"></i>${message}
      <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
    `;
    
    document.body.appendChild(notification);
    
    // 5秒後に自動削除
    setTimeout(() => {
      if (notification.parentNode) {
        notification.remove();
      }
    }, 5000);
  }
  
  function showWinnerModal(winner) {
    const modalHtml = `
      <div class="modal fade" id="winnerModal" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header bg-success text-white">
              <h5 class="modal-title">🎉 ゲーム終了</h5>
            </div>
            <div class="modal-body text-center">
              <h3 class="text-success">${winner}さんの勝利です！</h3>
              <p>おめでとうございます！</p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-primary" onclick="location.reload()">OK</button>
            </div>
          </div>
        </div>
      </div>
    `;
    
    // 既存のモーダルを削除
    const existingModal = document.getElementById('winnerModal');
    if (existingModal) {
      existingModal.remove();
    }
    
    // 新しいモーダルを追加
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // モーダルを表示
    const modal = new bootstrap.Modal(document.getElementById('winnerModal'));
    modal.show();
  }
  
  // スクロール位置維持のためのJavaScript
  document.addEventListener('DOMContentLoaded', function() {
    const searchForm = document.getElementById('fighter-search-form');
    if (searchForm) {
      searchForm.addEventListener('submit', function() {
        // 現在のスクロール位置を保存
        sessionStorage.setItem('gameSessionScrollPosition', window.scrollY);
      });
      
      // ページ読み込み後にスクロール位置を復元
      const savedScrollPosition = sessionStorage.getItem('gameSessionScrollPosition');
      if (savedScrollPosition) {
        window.scrollTo(0, parseInt(savedScrollPosition));
        sessionStorage.removeItem('gameSessionScrollPosition');
      }
    }
  });
</script>

<div class="container-fluid px-0">
  <!-- ゲームヘッダー -->
  <div class="game-header-container mb-4">
    <div class="game-main-header">
      <div class="header-content">
        <h1 class="game-title">
          <span class="title-icon">🚃</span>
          <%= @game_session.name %>
        </h1>
        <div class="game-status-badge">
          <span class="badge-text <%= @game_session.status %>">
            <%= case @game_session.status
                when 'waiting' then '⏳ WAITING'
                when 'playing' then '🎮 PLAYING'
                when 'finished' then '🏁 FINISHED'
                end %>
          </span>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- メインゲーム画面 -->
    <div class="col-lg-8 mb-4">

      <!-- 現在のターン表示とアクション -->
      <% if @game_session.playing? && @game_session.current_turn_player == current_user %>
        <div class="your-turn-container mb-4">
          <div class="your-turn-card">
            <div class="turn-header">
              <div class="turn-icon">🎯</div>
              <h2 class="turn-title">YOUR TURN!</h2>
              <div class="retire-section">
                <%= button_to retire_game_session_path(@game_session), method: :patch, 
                              class: "retire-btn", confirm: "リタイアしますか？ゲームから脱落します。" do %>
                  <span class="retire-icon">🏃</span>
                  <span class="retire-text">RETIRE</span>
                <% end %>
              </div>
            </div>
            
            <div class="turn-body">
              <div class="fighter-search-section">
                <div class="search-label-container">
                  <label class="search-label">
                    <span class="search-icon">🔍</span>
                    Fighter Name (Hiragana)
                  </label>
                </div>
                
                <%= form_with url: game_session_path(@game_session), method: :get, local: true, 
                              data: { turbo: false }, id: "fighter-search-form" do |form| %>
                  <div class="search-input-wrapper">
                    <%= form.text_field :query, value: params[:query], 
                                        placeholder: "ひらがなで入力してください...", 
                                        class: "game-search-input", id: "fighter-search" %>
                    <div class="search-decoration">
                      <div class="search-glow"></div>
                    </div>
                  </div>
                  
                  <div class="search-actions">
                    <%= form.submit "SEARCH", class: "search-btn" %>
                  </div>
                <% end %>
                
                <% if @single_candidate %>
                  <div class="candidate-result-section">
                    <div class="candidate-card">
                      <div class="candidate-header">
                        <div class="candidate-icon">🎉</div>
                        <h3 class="candidate-title">FIGHTER FOUND!</h3>
                      </div>
                      <div class="candidate-body">
                        <div class="candidate-fighter-info">
                          <div class="candidate-fighter-image">
                            <% if @single_candidate.image_url.present? %>
                              <img src="<%= @single_candidate.image_url %>" 
                                   alt="<%= @single_candidate.display_name %>" 
                                   class="candidate-image">
                            <% else %>
                              <div class="candidate-placeholder">
                                <div class="placeholder-icon">👤</div>
                              </div>
                            <% end %>
                          </div>
                          <div class="fighter-info">
                            <div class="fighter-name"><%= @single_candidate.display_name %></div>
                            <div class="fighter-hiragana">(<%= @single_candidate.full_name_hiragana %>)</div>
                          </div>
                        </div>
                        <%= form_with url: submit_fighter_game_session_path(@game_session), method: :post, local: true do |form| %>
                          <%= form.hidden_field :fighter_id, value: @single_candidate.id %>
                          <%= form.submit "SELECT THIS FIGHTER", class: "select-fighter-btn" %>
                        <% end %>
                      </div>
                    </div>
                  </div>
                <% end %>
                
                <% if params[:query].present? && @search_results&.any? && !@single_candidate %>
                  <div class="search-status multiple-results">
                    <div class="status-icon">⚠️</div>
                    <div class="status-text">
                      <strong>Multiple fighters found!</strong><br>
                      Please narrow down by typing more hiragana.
                    </div>
                  </div>
                <% end %>
                
                <% if params[:query].present? && @search_results&.empty? %>
                  <div class="search-status no-results">
                    <div class="status-icon">❌</div>
                    <div class="status-text">
                      No fighter found for "<%= params[:query] %>"
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        </div>
      <% elsif @game_session.playing? %>
        <div class="waiting-turn-container mb-4">
          <div class="waiting-turn-card">
            <div class="waiting-header">
              <div class="waiting-icon">⏳</div>
              <h3 class="waiting-title">WAITING</h3>
            </div>
            <div class="waiting-body">
              <div class="current-player-name"><%= @game_session.current_turn_player.name %></div>
              <div class="waiting-text">is choosing a fighter...</div>
              <div class="waiting-animation">
                <div class="loading-dots">
                  <span>.</span><span>.</span><span>.</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      <% elsif @game_session.finished? && @game_session.winner %>
        <div class="game-finished-container mb-4">
          <div class="finished-card">
            <div class="finished-header">
              <div class="winner-crown">👑</div>
              <h2 class="finished-title">GAME OVER!</h2>
            </div>
            <div class="finished-body">
              <div class="winner-announcement">
                <div class="winner-label">CHAMPION</div>
                <div class="winner-name"><%= @game_session.winner.name %></div>
                <div class="celebration-effects">
                  <div class="sparkle">✨</div>
                  <div class="sparkle">🎊</div>
                  <div class="sparkle">⭐</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      <% end %>

      <!-- 使用済み選手一覧 -->
      <% if @used_fighters.any? %>
        <div class="used-fighters-container">
          <div class="used-fighters-header">
            <div class="header-icon">📝</div>
            <h3 class="header-title">USED FIGHTERS</h3>
            <div class="fighters-count">(<%= @used_fighters.count %>)</div>
          </div>
          
          <div class="used-fighters-grid">
            <% @used_fighters.each_with_index do |used_fighter, index| %>
              <%= link_to used_fighter.fighter, class: "used-fighter-card-link", style: "animation-delay: #{index * 0.1}s" do %>
                <div class="used-fighter-card">
                  <div class="fighter-image-section">
                    <% if used_fighter.fighter.image_url.present? %>
                      <img src="<%= used_fighter.fighter.image_url %>" 
                           alt="<%= used_fighter.fighter.display_name %>" 
                           class="used-fighter-image">
                    <% else %>
                      <div class="used-fighter-placeholder">
                        <div class="placeholder-icon">👤</div>
                      </div>
                    <% end %>
                    <div class="fighter-overlay">
                      <div class="order-badge">#<%= index + 1 %></div>
                    </div>
                  </div>
                  
                  <div class="fighter-info-section">
                    <div class="fighter-name">
                      <%= used_fighter.fighter.display_name %>
                    </div>
                  </div>
                </div>
              <% end %>
            <% end %>
          </div>
        </div>
      <% end %>
  </div>

    <!-- サイドバー - プレイヤー情報・操作 -->
    <div class="col-lg-4">
      <!-- プレイヤーリスト -->
      <div class="players-container mb-4">
        <div class="players-header">
          <div class="players-icon">👥</div>
          <h3 class="players-title">PLAYERS</h3>
          <div class="players-count">(<%= @players.count %>)</div>
        </div>
        
        <div class="players-list">
          <% @players.each_with_index do |game_player, index| %>
            <div class="player-item <%= 'current-player' if game_player.current_turn? %> <%= 'eliminated' if game_player.is_eliminated %>" 
                 style="animation-delay: <%= index * 0.1 %>s">
              <div class="player-info">
                <div class="player-order">#<%= game_player.turn_order %></div>
                <div class="player-details">
                  <div class="player-name"><%= game_player.user.name %></div>
                  <div class="player-status">
                    <% if game_player.is_eliminated %>
                      <span class="status-badge eliminated">💀 ELIMINATED</span>
                    <% elsif game_player.current_turn? %>
                      <span class="status-badge active">⚡ ACTIVE</span>
                    <% else %>
                      <span class="status-badge waiting">⏳ WAITING</span>
                    <% end %>
                  </div>
                </div>
              </div>
              
              <% if @game_session.creator == current_user && @game_session.playing? && !game_player.is_eliminated %>
                <div class="player-actions">
                  <%= form_with url: eliminate_player_game_session_path(@game_session), method: :patch, local: true, class: "eliminate-form" do |form| %>
                    <%= form.hidden_field :user_id, value: game_player.user.id %>
                    <%= form.submit "🚫", class: "eliminate-btn", 
                                    title: "Eliminate #{game_player.user.name}",
                                    confirm: "#{game_player.user.name}さんを脱落させますか？" %>
                  <% end %>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
      </div>

      <!-- ゲーム操作パネル -->
      <div class="game-controls-container">
        <div class="controls-header">
          <div class="controls-icon">🎮</div>
          <h3 class="controls-title">GAME CONTROL</h3>
        </div>
        
        <div class="controls-body">
          <% if @game_session.waiting? %>
            <% if @game_session.creator == current_user %>
              <% if @game_session.game_players.count >= 2 %>
                <%= button_to start_game_game_session_path(@game_session), method: :patch, 
                              class: "control-btn start-btn", confirm: "ゲームを開始しますか？" do %>
                  <span class="btn-icon">🚀</span>
                  <span class="btn-text">START GAME</span>
                <% end %>
              <% else %>
                <div class="status-message waiting">
                  <div class="message-icon">⚠️</div>
                  <div class="message-text">Need at least 2 players</div>
                </div>
              <% end %>
              <%= link_to edit_game_session_path(@game_session), class: "control-btn settings-btn" do %>
                <span class="btn-icon">⚙️</span>
                <span class="btn-text">SETTINGS</span>
              <% end %>
            <% end %>
          <% end %>

          <%= button_to leave_game_session_path(@game_session), method: :delete, 
                        class: "control-btn leave-btn", 
                        confirm: @game_session.playing? ? "ゲームから脱落しますか？" : "ゲームから退出しますか？" do %>
            <span class="btn-icon">🚪</span>
            <span class="btn-text">LEAVE GAME</span>
          <% end %>
          
          <%= link_to game_sessions_path, class: "control-btn back-btn" do %>
            <span class="btn-icon">🔙</span>
            <span class="btn-text">BACK TO LOBBY</span>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>
</div>
