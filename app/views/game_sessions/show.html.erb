<h1><%= @game_session.name %></h1>

<script>
  let gameChannel = null;
  
  function initializeActionCable() {
    if (window.App && window.App.cable) {
      const gameSessionId = <%= @game_session.id %>;
      
      gameChannel = window.App.cable.subscriptions.create(
        { 
          channel: "GameChannel", 
          game_session_id: gameSessionId 
        },
        {
          connected: function() {
            console.log(`Connected to GameChannel for session ${gameSessionId}`);
          },

          disconnected: function() {
            console.log('Disconnected from GameChannel');
          },

          received: function(data) {
            console.log('Received game update:', data);
            handleGameUpdate(data);
          }
        }
      );
    } else {
      console.error('Action Cable not available, retrying in 1 second...');
      setTimeout(initializeActionCable, 1000);
    }
  }
  
  document.addEventListener('DOMContentLoaded', function() {
    // ActionCableã®åˆæœŸåŒ–ã‚’å°‘ã—é…ã‚‰ã›ã‚‹
    setTimeout(initializeActionCable, 500);
  });
  
  function handleGameUpdate(data) {
    console.log('Handling update:', data.type);
    
    // é€šçŸ¥ã‚’è¡¨ç¤º
    if (data.message) {
      showNotification(data.message);
    }
    
    // ã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦å‡¦ç†
    switch(data.type) {
      case 'player_action':
        if (data.current_player_name) {
          updateCurrentTurn(data.current_player_name, data.current_player_id);
        }
        // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆç°¡æ˜“ç‰ˆï¼‰
        setTimeout(() => {
          location.reload();
        }, 2000);
        break;
        
      case 'game_status':
        if (data.status === 'finished' && data.winner) {
          showWinnerModal(data.winner);
        } else if (data.status === 'playing') {
          setTimeout(() => {
            location.reload();
          }, 1000);
        }
        break;
        
      case 'player_joined':
      case 'player_left':
        setTimeout(() => {
          location.reload();
        }, 1000);
        break;
    }
  }
  
  function updateCurrentTurn(playerName, playerId) {
    const currentUserId = document.body.dataset.currentUserId;
    const turnMessage = document.querySelector('.current-turn-message');
    
    if (turnMessage) {
      if (playerId == currentUserId) {
        turnMessage.innerHTML = '<div class="alert alert-success">ã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³ã§ã™ï¼</div>';
      } else {
        turnMessage.innerHTML = `<div class="alert alert-info">${playerName}ã•ã‚“ã®ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚ãŠå¾…ã¡ãã ã•ã„ã€‚</div>`;
      }
    }
  }
  
  function showNotification(message) {
    // æ—¢å­˜ã®é€šçŸ¥ã‚’å‰Šé™¤
    const existingNotifications = document.querySelectorAll('.game-notification');
    existingNotifications.forEach(n => n.remove());
    
    // æ–°ã—ã„é€šçŸ¥ã‚’ä½œæˆ
    const notification = document.createElement('div');
    notification.className = 'alert alert-info alert-dismissible fade show position-fixed game-notification';
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; max-width: 400px;';
    notification.innerHTML = `
      <i class="fas fa-info-circle me-2"></i>${message}
      <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
    `;
    
    document.body.appendChild(notification);
    
    // 5ç§’å¾Œã«è‡ªå‹•å‰Šé™¤
    setTimeout(() => {
      if (notification.parentNode) {
        notification.remove();
      }
    }, 5000);
  }
  
  function showWinnerModal(winner) {
    const modalHtml = `
      <div class="modal fade" id="winnerModal" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header bg-success text-white">
              <h5 class="modal-title">ğŸ‰ ã‚²ãƒ¼ãƒ çµ‚äº†</h5>
            </div>
            <div class="modal-body text-center">
              <h3 class="text-success">${winner}ã•ã‚“ã®å‹åˆ©ã§ã™ï¼</h3>
              <p>ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼</p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-primary" onclick="location.reload()">OK</button>
            </div>
          </div>
        </div>
      </div>
    `;
    
    // æ—¢å­˜ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å‰Šé™¤
    const existingModal = document.getElementById('winnerModal');
    if (existingModal) {
      existingModal.remove();
    }
    
    // æ–°ã—ã„ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¿½åŠ 
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    const modal = new bootstrap.Modal(document.getElementById('winnerModal'));
    modal.show();
  }
</script>

<div class="row">
  <!-- ã‚²ãƒ¼ãƒ çŠ¶æ…‹è¡¨ç¤º -->
  <div class="col-md-8">
    <div class="card mb-3">
      <div class="card-body">
        <h5 class="card-title">
          ã‚²ãƒ¼ãƒ çŠ¶æ…‹: 
          <span class="badge <%= case @game_session.status
                                 when 'waiting' then 'bg-warning'
                                 when 'playing' then 'bg-success'  
                                 when 'finished' then 'bg-secondary'
                                 end %>">
            <%= case @game_session.status
                when 'waiting' then 'å¾…æ©Ÿä¸­'
                when 'playing' then 'ãƒ—ãƒ¬ã‚¤ä¸­'
                when 'finished' then 'çµ‚äº†'
                end %>
          </span>
        </h5>
        
        <% if @game_session.playing? %>
          <p class="mb-2">
            <strong>ç¾åœ¨ã®ã‚¿ãƒ¼ãƒ³:</strong> 
            <span class="text-primary"><%= @game_session.current_turn_player.name %>ã•ã‚“</span>
          </p>
        <% end %>
        
        <% if @game_session.finished? && @game_session.winner %>
          <div class="alert alert-success">
            <h4>ğŸ‰ å‹è€…: <%= @game_session.winner.name %>ã•ã‚“</h4>
          </div>
        <% end %>
      </div>
    </div>

    <!-- é¸æ‰‹æ¤œç´¢ãƒ»é¸æŠ -->
    <% if @game_session.playing? && @game_session.current_turn_player == current_user %>
      <div class="card mb-3">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="card-title mb-0">ã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³ã§ã™ - é¸æ‰‹ã‚’é¸æŠã—ã¦ãã ã•ã„</h5>
            <%= button_to "ãƒªã‚¿ã‚¤ã‚¢", retire_game_session_path(@game_session), 
                          method: :patch, class: "btn btn-outline-danger btn-sm",
                          confirm: "ãƒªã‚¿ã‚¤ã‚¢ã—ã¾ã™ã‹ï¼Ÿã‚²ãƒ¼ãƒ ã‹ã‚‰è„±è½ã—ã¾ã™ã€‚" %>
          </div>
          
          <%= form_with url: game_session_path(@game_session), method: :get, local: true do |form| %>
            <%= form.text_field :query, value: params[:query], placeholder: "é¸æ‰‹åã‚’ã²ã‚‰ãŒãªã§å…¥åŠ›", 
                                class: "form-control mb-2", id: "fighter-search" %>
            <%= form.submit "æ¤œç´¢", class: "btn btn-outline-primary btn-sm" %>
          <% end %>

          <% if @single_candidate %>
            <div class="alert alert-info mt-3">
              <strong>å€™è£œãŒ1ä»¶ã«çµã‚Šè¾¼ã¾ã‚Œã¾ã—ãŸ:</strong>
              <%= form_with url: submit_fighter_game_session_path(@game_session), method: :post, local: true do |form| %>
                <%= form.hidden_field :fighter_id, value: @single_candidate.id %>
                <div class="d-flex align-items-center">
                  <span class="me-3"><%= @single_candidate.display_name %> (<%= @single_candidate.full_name_hiragana %>)</span>
                  <%= form.submit "ã“ã®é¸æ‰‹ã‚’é¸æŠ", class: "btn btn-success btn-sm" %>
                </div>
              <% end %>
            </div>
          <% end %>

          <% if params[:query].present? && @search_results&.any? && !@single_candidate %>
            <div class="alert alert-warning mt-3">
              <strong>è¤‡æ•°ã®é¸æ‰‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸï¼</strong><br>
              ä¸€äººã«çµã‚Œã‚‹ã¾ã§ã²ã‚‰ãŒãªã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
            </div>
          <% end %>
          
          <% if params[:query].present? && @search_results&.empty? %>
            <div class="alert alert-info mt-3">
              ã€Œ<%= params[:query] %>ã€ã«ä¸€è‡´ã™ã‚‹é¸æ‰‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚
            </div>
          <% end %>
        </div>
      </div>
    <% elsif @game_session.playing? %>
      <div class="alert alert-info">
        <%= @game_session.current_turn_player.name %>ã•ã‚“ã®ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚ãŠå¾…ã¡ãã ã•ã„ã€‚
      </div>
    <% end %>

    <!-- ä½¿ç”¨æ¸ˆã¿é¸æ‰‹ä¸€è¦§ -->
    <% if @used_fighters.any? %>
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">ä½¿ç”¨æ¸ˆã¿é¸æ‰‹ (<%= @used_fighters.count %>äºº)</h5>
          <div class="row">
            <% @used_fighters.each do |used_fighter| %>
              <div class="col-md-6 mb-2">
                <div class="used-fighter-item d-flex justify-content-between">
                  <span class="fw-bold"><%= used_fighter.fighter.display_name %></span>
                  <small class="text-muted"><%= used_fighter.used_by.name %></small>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
  </div>

  <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ - ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±ãƒ»æ“ä½œ -->
  <div class="col-md-4">
    <div class="card mb-3">
      <div class="card-body">
        <h5 class="card-title">å‚åŠ è€… (<%= @players.count %>äºº)</h5>
        <% @players.each do |game_player| %>
          <div class="player-card d-flex justify-content-between align-items-center mb-2 p-3 rounded
                      <%= 'current-turn' if game_player.current_turn? %>">
            <div>
              <span class="<%= 'fw-bold text-primary' if game_player.current_turn? %>">
                <%= game_player.turn_order %>. <%= game_player.user.name %>
              </span>
              <% if game_player.is_eliminated %>
                <span class="badge bg-danger ms-1">è„±è½</span>
              <% elsif game_player.current_turn? %>
                <span class="badge bg-success ms-1">ã‚¿ãƒ¼ãƒ³ä¸­</span>
              <% end %>
            </div>
            
            <% if @game_session.creator == current_user && @game_session.playing? && !game_player.is_eliminated %>
              <%= form_with url: eliminate_player_game_session_path(@game_session), method: :patch, local: true, class: "d-inline" do |form| %>
                <%= form.hidden_field :user_id, value: game_player.user.id %>
                <%= form.submit "è„±è½", class: "btn btn-outline-danger btn-sm", 
                                confirm: "#{game_player.user.name}ã•ã‚“ã‚’è„±è½ã•ã›ã¾ã™ã‹ï¼Ÿ" %>
              <% end %>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>

    <!-- ã‚²ãƒ¼ãƒ æ“ä½œ -->
    <div class="card">
      <div class="card-body">
        <h5 class="card-title">æ“ä½œ</h5>
        
        <% if @game_session.waiting? %>
          <% if @game_session.creator == current_user %>
            <% if @game_session.game_players.count >= 2 %>
              <%= button_to "ã‚²ãƒ¼ãƒ é–‹å§‹", start_game_game_session_path(@game_session), 
                          method: :patch, class: "btn btn-success w-100 mb-2",
                          confirm: "ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿ" %>
            <% else %>
              <div class="alert alert-warning">
                æœ€ä½2äººã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå¿…è¦ã§ã™
              </div>
            <% end %>
            <%= link_to "è¨­å®šå¤‰æ›´", edit_game_session_path(@game_session), class: "btn btn-outline-primary w-100 mb-2" %>
          <% end %>
        <% end %>

        <%= button_to "é€€å‡º", leave_game_session_path(@game_session), 
                    method: :delete, class: "btn btn-outline-danger w-100 mb-2",
                    confirm: @game_session.playing? ? "ã‚²ãƒ¼ãƒ ã‹ã‚‰è„±è½ã—ã¾ã™ã‹ï¼Ÿ" : "ã‚²ãƒ¼ãƒ ã‹ã‚‰é€€å‡ºã—ã¾ã™ã‹ï¼Ÿ" %>
        
        <%= link_to "ã‚²ãƒ¼ãƒ ä¸€è¦§ã«æˆ»ã‚‹", game_sessions_path, class: "btn btn-secondary w-100" %>
      </div>
    </div>
  </div>
</div>
