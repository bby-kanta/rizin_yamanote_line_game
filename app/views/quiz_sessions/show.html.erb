<div class="container">
  <div class="row">
    <div class="col-md-8">
      <h1 class="mb-4">
        üîç „ÇØ„Ç§„Ç∫ #<%= @quiz_session.id %>
        <% if @quiz_session.waiting? %>
          <span class="badge bg-warning text-dark">ÂæÖÊ©ü‰∏≠</span>
        <% elsif @quiz_session.started? %>
          <span class="badge bg-success">„Éó„É¨„Ç§‰∏≠</span>
        <% else %>
          <span class="badge bg-secondary">ÁµÇ‰∫Ü</span>
        <% end %>
      </h1>

      <!-- „Ç≤„Éº„É†Áä∂ÊÖã„Å´Âøú„Åò„ÅüË°®Á§∫ -->
      <% if @quiz_session.waiting? %>
        <div class="alert alert-info">
          <h5 class="alert-heading">‚è≥ „Ç≤„Éº„É†ÈñãÂßã„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô</h5>
          <p>‰ΩúÊàêËÄÖ: <%= @quiz_session.creator.name %></p>
          
          <!-- Êé•Á∂öÁä∂Ê≥ÅË°®Á§∫ -->
          <div id="connection-status" class="mb-3">
            <div class="connection-info">
              <span class="connection-label">Êé•Á∂öÁä∂Ê≥Å:</span>
              <span id="connected-count"><%= @quiz_session.quiz_participants.connected.count %></span>
              /
              <span id="total-count"><%= @quiz_session.quiz_participants.count %></span>
              ‰∫∫„ÅåÊé•Á∂öÊ∏à„Åø
            </div>
            <div class="progress mt-2" style="height: 8px;">
              <div id="connection-progress" class="progress-bar bg-success" role="progressbar" 
                   style="width: <%= @quiz_session.quiz_participants.count > 0 ? (@quiz_session.quiz_participants.connected.count.to_f / @quiz_session.quiz_participants.count * 100) : 0 %>%"></div>
            </div>
            
            <!-- „É™„É≠„Éº„Éâ„Éú„Çø„É≥„Å®Ëá™ÂãïÊõ¥Êñ∞Ë°®Á§∫ -->
            <div class="reload-button-container mt-3 text-center">
              <button id="reload-btn" class="btn btn-outline-primary btn-sm" onclick="location.reload()">
                <span class="btn-icon">üîÑ</span>
                <span class="btn-text">Êé•Á∂öÁä∂Ê≥Å„ÇíÊõ¥Êñ∞</span>
              </button>
              <div id="auto-reload-info" class="auto-reload-info mt-2">
                <small class="text-muted">
                  Ëá™ÂãïÊõ¥Êñ∞„Åæ„Åß„ÅÇ„Å® <span id="countdown">10</span> Áßí
                </small>
              </div>
            </div>
          </div>
          
          <% if @quiz_session.creator == current_user && @quiz_session.participants.count >= 2 %>
            <div id="start-button-container">
              <% if @quiz_session.all_participants_connected? %>
                <button id="start-game-btn" class="btn btn-success btn-lg" onclick="startGame()">
                  <span class="btn-icon">üöÄ</span>
                  <span class="btn-text">„Ç≤„Éº„É†„ÇíÈñãÂßã</span>
                </button>
              <% else %>
                <button id="start-game-btn" class="btn btn-secondary btn-lg" disabled>
                  <span class="btn-icon">‚è≥</span>
                  <span class="btn-text">ÂÖ®Âì°„ÅÆÊé•Á∂ö„ÇíÂæÖÊ©ü‰∏≠...</span>
                </button>
              <% end %>
            </div>
          <% elsif @quiz_session.creator == current_user %>
            <p class="text-muted">‰ªñ„ÅÆÂèÇÂä†ËÄÖ„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô...ÔºàÊúÄ‰Ωé2‰∫∫ÂøÖË¶ÅÔºâ</p>
          <% elsif @can_join %>
            <%= button_to "ÂèÇÂä†„Åô„Çã", join_quiz_session_path(@quiz_session), method: :patch, class: "btn btn-primary btn-lg" %>
          <% elsif @participant %>
            <div class="participant-waiting">
              <p>ÂèÇÂä†Ê∏à„Åø - „Ç≤„Éº„É†ÈñãÂßã„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô</p>
              <div id="participant-connection-status" class="mt-2">
                <% if @participant.connected? %>
                  <span class="badge bg-success">‚úì Êé•Á∂öÊ∏à„Åø</span>
                <% else %>
                  <span class="badge bg-warning">‚è≥ Êé•Á∂ö‰∏≠...</span>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>

      <% elsif @quiz_session.started? %>
        <!-- „Ç§„Ç±„Ç§„Ç±„Éí„É≥„ÉàË°®Á§∫ -->
        <div class="hint-container mb-4">
          <div class="hint-main-card">
            <div class="hint-header">
              <div class="hint-number-badge">
                <span class="hint-number">#<%= @quiz_session.current_hint_index + 1 %></span>
              </div>
              <h2 class="hint-title">
                <span class="hint-icon">üí°</span>
                CURRENT HINT
              </h2>
            </div>
            
            <div class="hint-body" id="current-hint">
              <% if @current_hint %>
                <div class="hint-content">
                  <div class="hint-meta">
                    <div class="category-badge">
                      <span class="category-text"><%= @current_hint.category_name %></span>
                    </div>
                    <div class="level-indicator">
                      <div class="level-label">DIFFICULTY</div>
                      <div class="level-value level-<%= @current_hint.level %>">
                        <% @current_hint.level.times do %>‚≠ê<% end %>
                      </div>
                    </div>
                  </div>
                  
                  <div class="feature-display">
                    <div class="feature-text">
                      "<%= @current_hint.feature %>"
                    </div>
                    <div class="hint-decoration">
                      <div class="decoration-element">üéØ</div>
                      <div class="decoration-element">‚ú®</div>
                      <div class="decoration-element">üî•</div>
                    </div>
                  </div>
                </div>
              <% else %>
                <div class="no-hint-message">
                  <div class="no-hint-icon">ü§î</div>
                  <p>„Éí„É≥„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>
                </div>
              <% end %>
            </div>
          </div>
        </div>

        <!-- „Ç§„Ç±„Ç§„Ç±ÂõûÁ≠î„Éï„Ç©„Éº„É† -->
        <% if @participant && !@participant.answered? && !@quiz_session.quiz_answers.where(user: current_user, hint_index: @quiz_session.current_hint_index).exists? %>
          <div class="answer-container mb-4">
            <div class="answer-main-card">
              <div class="answer-header">
                <div class="answer-icon">üéØ</div>
                <h3 class="answer-title">YOUR GUESS</h3>
                <div class="miss-counter">
                  <span class="miss-label">MISSES</span>
                  <div class="miss-value">
                    <span class="miss-number"><%= @participant.miss_count %></span>
                    <span class="miss-icon">‚ùå</span>
                  </div>
                </div>
              </div>
              
              <div class="answer-body">
                <form action="<%= submit_answer_quiz_session_path(@quiz_session) %>" method="post" id="answer-form" data-turbo="false" data-method="post">
                  <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
                  <input type="hidden" name="_method" value="post">
                  
                  <div class="fighter-search-section">
                    <div class="search-label-container">
                      <label for="fighter_name" class="search-label">
                        <span class="search-icon">üîç</span>
                        Fighter Name (Hiragana)
                      </label>
                    </div>
                    
                    <div class="search-input-wrapper">
                      <input type="text" name="fighter_name" class="fighter-search-input" id="fighter-search" placeholder="„Å≤„Çâ„Åå„Å™„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ...">
                      <div class="search-decoration">
                        <div class="search-glow"></div>
                      </div>
                    </div>
                    
                    <div id="fighter-suggestions" class="suggestions-container"></div>
                  </div>
                  
                  <input type="hidden" name="fighter_id" id="fighter-id">
                  
                  <div class="action-buttons">
                    <button type="submit" class="submit-btn" id="submit-answer" disabled>
                      <span class="btn-icon">‚ö°</span>
                      <span class="btn-text">SUBMIT ANSWER</span>
                      <div class="btn-glow"></div>
                    </button>
                  </div>
                </form>
                
                <!-- „Éë„Çπ„Éú„Çø„É≥ -->
                <div class="pass-section">
                  <button type="button" class="pass-btn" id="pass-btn">
                    <span class="pass-icon">‚è≠Ô∏è</span>
                    <span class="btn-text pass-text">PASS THIS HINT</span>
                  </button>
                </div>
              </div>
            </div>
          </div>
        <% elsif @participant && @participant.answered? %>
          <!-- Ê≠£Ëß£Áä∂ÊÖã -->
          <div class="status-container mb-4">
            <div class="status-card success-status">
              <div class="status-header">
                <div class="status-icon success-icon">üéâ</div>
                <h3 class="status-title">CORRECT!</h3>
              </div>
              <div class="status-body">
                <p class="status-message">„ÅÇ„Å™„Åü„ÅØÊ≠£Ëß£„Åó„Åæ„Åó„ÅüÔºÅ</p>
                <div class="waiting-animation">
                  <div class="waiting-text">‰ªñ„ÅÆÂèÇÂä†ËÄÖ„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô</div>
                  <div class="loading-dots">
                    <span>.</span><span>.</span><span>.</span>
                  </div>
                </div>
              </div>
              <div class="status-decoration">
                <div class="celebration-particle">‚ú®</div>
                <div class="celebration-particle">üéä</div>
                <div class="celebration-particle">‚≠ê</div>
              </div>
            </div>
          </div>
        <% elsif @participant && @quiz_session.quiz_answers.where(user: current_user, hint_index: @quiz_session.current_hint_index).exists? %>
          <% current_answer = @quiz_session.quiz_answers.where(user: current_user, hint_index: @quiz_session.current_hint_index).last %>
          <div class="status-container mb-4">
            <% if current_answer.passed? %>
              <!-- „Éë„ÇπÁä∂ÊÖã -->
              <div class="status-card pass-status">
                <div class="status-header">
                  <div class="status-icon pass-icon">‚è≠Ô∏è</div>
                  <h3 class="status-title">PASSED</h3>
                </div>
                <div class="status-body">
                  <p class="status-message">„Åì„ÅÆ„Éí„É≥„Éà„Çí„Éë„Çπ„Åó„Åæ„Åó„Åü</p>
                  <div class="waiting-animation">
                    <div class="waiting-text">Ê¨°„ÅÆ„Éí„É≥„Éà„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô</div>
                    <div class="loading-dots">
                      <span>.</span><span>.</span><span>.</span>
                    </div>
                  </div>
                </div>
              </div>
            <% else %>
              <!-- ‰∏çÊ≠£Ëß£Áä∂ÊÖã -->
              <div class="status-card incorrect-status">
                <div class="status-header">
                  <div class="status-icon incorrect-icon">üò§</div>
                  <h3 class="status-title">INCORRECT</h3>
                </div>
                <div class="status-body">
                  <p class="status-message">ÊÆãÂøµÔºÅ‰∏çÊ≠£Ëß£„Åß„Åó„Åü</p>
                  <div class="waiting-animation">
                    <div class="waiting-text">Ê¨°„ÅÆ„ÉÅ„É£„É≥„Çπ„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô</div>
                    <div class="loading-dots">
                      <span>.</span><span>.</span><span>.</span>
                    </div>
                  </div>
                </div>
                <div class="status-decoration">
                  <div class="incorrect-particle">üí•</div>
                </div>
              </div>
            <% end %>
          </div>
        <% end %>

      <% else %>
        <!-- ÁµÇ‰∫ÜÊôÇ„ÅÆÁµêÊûúË°®Á§∫ - „Ç§„Ç±„Ç§„Ç±„Éá„Ç∂„Ç§„É≥ -->
        <div class="quiz-result-container mb-4">
          <!-- „É°„Ç§„É≥„ÅÆÁµêÊûú„Ç´„Éº„Éâ -->
          <div class="result-main-card">
            <div class="result-header">
              <div class="header-content">
                <h2 class="result-title">
                  <span class="title-icon">üéØ</span>
                  QUIZ COMPLETED!
                </h2>
                <div class="completion-badge">
                  <span class="badge-text">GAME OVER</span>
                </div>
              </div>
            </div>
            
            <div class="result-body">
              <!-- Ê≠£Ëß£ÈÅ∏Êâã„ÅÆË°®Á§∫ -->
              <div class="fighter-reveal-section">
                <div class="fighter-info-container">
                  <div class="fighter-image-wrapper">
                    <% if @quiz_session.target_fighter.image_url.present? %>
                      <img src="<%= @quiz_session.target_fighter.image_url %>" 
                           alt="<%= @quiz_session.target_fighter.display_name %>" 
                           class="fighter-image">
                      <div class="image-overlay">
                        <div class="overlay-text">ANSWER</div>
                      </div>
                    <% else %>
                      <div class="fighter-placeholder">
                        <div class="placeholder-icon">üë§</div>
                        <div class="placeholder-text">No Image</div>
                      </div>
                    <% end %>
                  </div>
                  
                  <div class="fighter-details">
                    <div class="answer-label">Ê≠£Ëß£</div>
                    <h1 class="fighter-name"><%= @quiz_session.target_fighter.display_name %></h1>
                  </div>
                </div>
              </div>
              
              <!-- ÂãùËÄÖË°®Á§∫ -->
              <div class="winner-section">
                <% if @quiz_session.winner_user %>
                  <div class="winner-announcement">
                    <div class="winner-crown">üëë</div>
                    <h2 class="winner-title">CHAMPION</h2>
                    <h3 class="winner-name"><%= @quiz_session.winner_user.name %></h3>
                    <div class="winner-effects">
                      <div class="sparkle">‚ú®</div>
                      <div class="sparkle">üéä</div>
                      <div class="sparkle">‚≠ê</div>
                    </div>
                  </div>
                <% else %>
                  <% max_points = @quiz_session.quiz_participants.maximum(:points) || 0 %>
                  <% top_count = @quiz_session.quiz_participants.where(points: max_points).count %>
                  <div class="no-winner-section">
                    <% if top_count > 1 %>
                      <div class="tie-announcement">
                        <div class="tie-icon">ü§ù</div>
                        <h3 class="tie-title">TIE GAME!</h3>
                        <p class="tie-message">Ë§áÊï∞„ÅÆ„ÉÅ„É£„É≥„Éî„Ç™„É≥</p>
                      </div>
                    <% else %>
                      <div class="no-winner-announcement">
                        <div class="no-winner-icon">üò§</div>
                        <h3 class="no-winner-title">NO CHAMPION</h3>
                        <p class="no-winner-message">„ÇÇ„ÅÜ‰∏ÄÂ∫¶ÊåëÊà¶„Åó„Çà„ÅÜÔºÅ</p>
                      </div>
                    <% end %>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        </div>

      <% end %>
    </div>

    <!-- „Çµ„Ç§„Éâ„Éê„ÉºÔºöÂèÇÂä†ËÄÖ„É™„Çπ„Éà -->
    <div class="col-md-4">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">üë• ÂèÇÂä†ËÄÖ (<%= @participants.count %>‰∫∫)</h5>
        </div>
        <div class="card-body">
          <ul class="list-group">
            <% @participants.each do |participant| %>
              <li class="list-group-item d-flex justify-content-between align-items-center" data-user-id="<%= participant.user_id %>">
                <div>
                  <%= participant.user.name %>
                  <% if participant.is_winner %>
                    <span class="badge bg-warning text-dark ms-2">üèÜ</span>
                  <% end %>
                </div>
                <div>
                  <% if participant.answered? %>
                    <span class="badge bg-success participant-status">Ê≠£Ëß£</span>
                  <% elsif @quiz_session.started? %>
                    <% current_hint_answer = @current_hint_answers&.dig(participant.user_id) %>
                    <% if current_hint_answer %>
                      <% if current_hint_answer.passed? %>
                        <span class="badge bg-secondary participant-status">„Éë„Çπ</span>
                      <% else %>
                        <span class="badge bg-warning participant-status">‰∏çÊ≠£Ëß£</span>
                      <% end %>
                    <% else %>
                      <span class="thinking-spinner participant-status"></span>
                    <% end %>
                  <% end %>
                  <% if @quiz_session.ended? %>
                    <span class="badge bg-primary"><%= participant.points %>pt</span>
                  <% end %>
                </div>
              </li>
            <% end %>
          </ul>
        </div>
      </div>

      <% if @quiz_session.ended? %>
        <div class="card mt-3">
          <div class="card-header">
            <h5 class="mb-0">üìä ÊúÄÁµÇÁµêÊûú</h5>
          </div>
          <div class="card-body">
            <ol class="list-group list-group-numbered">
              <% @participants.by_points.each_with_index do |participant, index| %>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <div>
                    <%= participant.user.name %>
                  </div>
                  <div>
                    <span class="badge bg-primary"><%= participant.points %>pt</span>
                    <span class="badge bg-danger">„Éü„Çπ: <%= participant.miss_count %>Âõû</span>
                  </div>
                </li>
              <% end %>
            </ol>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- „Ç´„Çπ„Çø„É†CSSÔºàÂÖ®„Å¶„ÅÆÁä∂ÊÖã„ÅßÈÅ©Áî®Ôºâ -->
<style>
          .quiz-result-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 0;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            overflow: hidden;
            position: relative;
          }
          
          .quiz-result-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" patternUnits="userSpaceOnUse" width="100" height="100"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="25" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            pointer-events: none;
          }

          .result-main-card {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            margin: 3px;
            border-radius: 17px;
            overflow: hidden;
          }

          .result-header {
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            padding: 30px;
            text-align: center;
            position: relative;
          }

          .result-title {
            font-size: 2.5rem;
            font-weight: 900;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin: 0;
            letter-spacing: 2px;
          }

          .title-icon {
            display: inline-block;
            font-size: 3rem;
            margin-right: 15px;
            animation: bounce 2s infinite;
          }

          .completion-badge {
            margin-top: 15px;
          }

          .badge-text {
            background: rgba(0,0,0,0.3);
            color: white;
            padding: 8px 20px;
            border-radius: 50px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.9rem;
          }

          .result-body {
            padding: 40px;
          }

          .fighter-reveal-section {
            text-align: center;
            margin-bottom: 40px;
          }

          .fighter-info-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
          }

          .fighter-image-wrapper {
            position: relative;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transition: transform 0.3s ease;
          }

          .fighter-image-wrapper:hover {
            transform: scale(1.05) rotate(1deg);
          }

          .fighter-image {
            width: 200px;
            height: 250px;
            object-fit: cover;
            display: block;
          }

          .fighter-placeholder {
            width: 200px;
            height: 250px;
            background: linear-gradient(135deg, #ff9a9e, #fecfef);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
          }

          .placeholder-icon {
            font-size: 4rem;
            margin-bottom: 10px;
          }

          .placeholder-text {
            font-weight: bold;
            font-size: 1.2rem;
          }

          .image-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255,107,107,0.8), rgba(254,202,87,0.8));
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
          }

          .fighter-image-wrapper:hover .image-overlay {
            opacity: 1;
          }

          .overlay-text {
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
          }

          .fighter-details {
            text-align: left;
            max-width: 300px;
          }

          .answer-label {
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            display: inline-block;
            margin-bottom: 15px;
            text-transform: uppercase;
          }

          .fighter-name {
            font-size: 2.2rem;
            font-weight: 900;
            color: #333;
            margin: 0 0 15px 0;
            line-height: 1.2;
          }

          .fighter-meta {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
          }

          .meta-item {
            background: #f8f9fa;
            color: #666;
            padding: 8px 12px;
            border-radius: 15px;
            font-size: 0.9rem;
            border: 2px solid #e9ecef;
          }

          .winner-section {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, #ffecd2, #fcb69f);
            border-radius: 20px;
            position: relative;
            overflow: hidden;
          }

          .winner-announcement {
            position: relative;
            z-index: 2;
          }

          .winner-crown {
            font-size: 4rem;
            margin-bottom: 10px;
            animation: float 3s ease-in-out infinite;
          }

          .winner-title {
            font-size: 2rem;
            font-weight: 900;
            color: #333;
            margin: 10px 0;
            text-transform: uppercase;
            letter-spacing: 2px;
          }

          .winner-name {
            font-size: 2.5rem;
            font-weight: 800;
            color: #ff6b6b;
            margin: 15px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
          }

          .winner-effects {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
          }

          .sparkle {
            position: absolute;
            font-size: 2rem;
            animation: sparkle 2s infinite;
          }

          .sparkle:nth-child(1) {
            top: 20%;
            left: 20%;
            animation-delay: 0s;
          }

          .sparkle:nth-child(2) {
            top: 30%;
            right: 20%;
            animation-delay: 0.7s;
          }

          .sparkle:nth-child(3) {
            bottom: 20%;
            left: 30%;
            animation-delay: 1.4s;
          }

          .no-winner-section {
            padding: 20px;
            text-align: center;
          }

          .tie-announcement, .no-winner-announcement {
            background: rgba(255,255,255,0.9);
            padding: 30px;
            border-radius: 15px;
            border: 3px dashed #ccc;
          }

          .tie-icon, .no-winner-icon {
            font-size: 3rem;
            margin-bottom: 15px;
          }

          .tie-title, .no-winner-title {
            font-size: 1.8rem;
            font-weight: bold;
            color: #666;
            margin: 10px 0;
          }

          .tie-message, .no-winner-message {
            color: #888;
            font-size: 1.1rem;
          }

          @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
          }

          @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
          }

          @keyframes sparkle {
            0%, 100% { opacity: 0; transform: scale(0.5) rotate(0deg); }
            50% { opacity: 1; transform: scale(1.2) rotate(180deg); }
          }

          /* ========== „ÇØ„Ç§„Ç∫ÂõûÁ≠îÁîªÈù¢Áî®CSS ========== */
          
          /* „Éí„É≥„ÉàË°®Á§∫„Çπ„Çø„Ç§„É´ */
          .hint-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 0;
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
            overflow: hidden;
            position: relative;
          }

          .hint-main-card {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            margin: 3px;
            border-radius: 17px;
            overflow: hidden;
          }

          .hint-header {
            background: linear-gradient(45deg, #4facfe, #00f2fe);
            padding: 25px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
          }

          .hint-number-badge {
            background: rgba(255,255,255,0.3);
            border: 2px solid rgba(255,255,255,0.5);
            border-radius: 50px;
            padding: 8px 16px;
            min-width: 60px;
            text-align: center;
          }

          .hint-number {
            font-size: 1.2rem;
            font-weight: bold;
            color: white;
          }

          .hint-title {
            font-size: 1.8rem;
            font-weight: 900;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin: 0;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 10px;
          }

          .hint-icon {
            font-size: 2rem;
            animation: pulse 2s infinite;
          }

          .hint-body {
            padding: 30px;
          }

          .hint-content {
            text-align: center;
          }

          .hint-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 30px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
          }

          .category-badge {
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            color: white;
            padding: 8px 20px;
            border-radius: 50px;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.9rem;
          }

          .level-indicator {
            text-align: center;
          }

          .level-label {
            font-size: 0.8rem;
            color: #666;
            font-weight: bold;
            margin-bottom: 5px;
          }

          .level-value {
            font-size: 1.2rem;
          }

          .level-1 { color: #ff4757; }
          .level-2 { color: #ffa502; }
          .level-3 { color: #2ed573; }

          .feature-display {
            position: relative;
            margin: 30px 0;
          }

          .feature-text {
            font-size: 1.8rem;
            font-weight: bold;
            color: #333;
            font-style: italic;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
            margin-bottom: 20px;
          }

          .hint-decoration {
            display: flex;
            justify-content: center;
            gap: 20px;
          }

          .decoration-element {
            font-size: 1.5rem;
            animation: float 3s ease-in-out infinite;
          }

          .decoration-element:nth-child(1) { animation-delay: 0s; }
          .decoration-element:nth-child(2) { animation-delay: 0.5s; }
          .decoration-element:nth-child(3) { animation-delay: 1s; }

          /* ÂõûÁ≠î„Éï„Ç©„Éº„É†„Çπ„Çø„Ç§„É´ */
          .answer-container {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-radius: 20px;
            padding: 0;
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
            overflow: hidden;
          }

          .answer-main-card {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            margin: 3px;
            border-radius: 17px;
            overflow: hidden;
          }

          .answer-header {
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            padding: 20px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
          }

          .answer-icon {
            font-size: 2.5rem;
            animation: bounce 2s infinite;
          }

          .answer-title {
            font-size: 1.6rem;
            font-weight: 900;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin: 0;
            letter-spacing: 1px;
            flex: 1;
            text-align: center;
          }

          .miss-counter {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
          }

          .miss-label {
            font-size: 0.8rem;
            color: rgba(255,255,255,0.8);
            font-weight: bold;
          }

          .miss-value {
            display: flex;
            align-items: center;
            gap: 5px;
            background: rgba(0,0,0,0.2);
            padding: 5px 10px;
            border-radius: 20px;
          }

          .miss-number {
            font-size: 1.2rem;
            font-weight: bold;
            color: white;
          }

          .miss-icon {
            font-size: 1rem;
          }

          .answer-body {
            padding: 30px;
          }

          .fighter-search-section {
            margin-bottom: 25px;
          }

          .search-label-container {
            margin-bottom: 15px;
          }

          .search-label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            color: #333;
          }

          .search-icon {
            font-size: 1.3rem;
          }

          .search-input-wrapper {
            position: relative;
          }

          .fighter-search-input {
            width: 100%;
            padding: 15px 20px;
            border: 3px solid #e1e8ed;
            border-radius: 15px;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            background: white;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
          }

          .fighter-search-input:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 20px rgba(102,126,234,0.3);
            transform: scale(1.02);
          }

          .suggestions-container {
            position: relative;
            z-index: 100;
          }

          .suggestions-container .list-group-item {
            border: none;
            border-radius: 10px;
            margin: 5px 0;
            transition: all 0.3s ease;
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
          }

          .suggestions-container .list-group-item:hover {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            transform: translateX(10px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
          }

          .action-buttons {
            display: flex;
            justify-content: center;
            margin: 25px 0;
          }

          .submit-btn {
            position: relative;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            overflow: hidden;
          }

          .submit-btn:enabled:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(102,126,234,0.4);
          }

          .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.6;
          }

          .btn-icon {
            font-size: 1.3rem;
          }

          .pass-section {
            text-align: center;
            margin-top: 20px;
          }

          .pass-btn {
            background: linear-gradient(45deg, #95a5a6, #7f8c8d);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
          }

          .pass-btn:hover {
            background: linear-gradient(45deg, #7f8c8d, #95a5a6);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
          }

          /* „Çπ„ÉÜ„Éº„Çø„ÇπË°®Á§∫„Çπ„Çø„Ç§„É´ */
          .status-container {
            position: relative;
          }

          .status-card {
            border-radius: 20px;
            padding: 0;
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
            overflow: hidden;
            position: relative;
          }

          .success-status {
            background: linear-gradient(135deg, #2ed573 0%, #17c0eb 100%);
          }

          .pass-status {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
          }

          .incorrect-status {
            background: linear-gradient(135deg, #ff4757 0%, #ff3742 100%);
          }

          .status-header {
            padding: 25px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
          }

          .status-icon {
            font-size: 3rem;
          }

          .success-icon { animation: bounce 2s infinite; }
          .pass-icon { animation: float 3s ease-in-out infinite; }
          .incorrect-icon { animation: shake 1s infinite; }

          .status-title {
            font-size: 2rem;
            font-weight: 900;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin: 0;
            letter-spacing: 2px;
          }

          .status-body {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            padding: 25px;
            text-align: center;
          }

          .status-message {
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
          }

          .waiting-animation {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
          }

          .waiting-text {
            color: #666;
            font-size: 1rem;
          }

          .loading-dots span {
            font-size: 1.5rem;
            animation: loading-dots 1.5s infinite;
          }

          .loading-dots span:nth-child(1) { animation-delay: 0s; }
          .loading-dots span:nth-child(2) { animation-delay: 0.3s; }
          .loading-dots span:nth-child(3) { animation-delay: 0.6s; }

          .status-decoration {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
          }

          .celebration-particle, .incorrect-particle {
            position: absolute;
            font-size: 2rem;
            animation: particle-float 3s infinite;
          }

          .celebration-particle:nth-child(1) {
            top: 20%;
            left: 20%;
            animation-delay: 0s;
          }

          .celebration-particle:nth-child(2) {
            top: 30%;
            right: 20%;
            animation-delay: 1s;
          }

          .celebration-particle:nth-child(3) {
            bottom: 20%;
            left: 30%;
            animation-delay: 2s;
          }

          .incorrect-particle {
            top: 50%;
            right: 20%;
            animation: explosion 1s infinite;
          }

          /* „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„Ç≠„Éº„Éï„É¨„Éº„É† */
          @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
          }

          @keyframes loading-dots {
            0%, 60%, 100% { opacity: 0; transform: translateY(0); }
            30% { opacity: 1; transform: translateY(-10px); }
          }

          @keyframes particle-float {
            0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.7; }
            50% { transform: translateY(-20px) rotate(180deg); opacity: 1; }
          }

          @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
          }

          @keyframes explosion {
            0% { transform: scale(1) rotate(0deg); opacity: 1; }
            50% { transform: scale(1.3) rotate(180deg); opacity: 0.7; }
            100% { transform: scale(1) rotate(360deg); opacity: 1; }
          }

          @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
          }

          .thinking-spinner {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid rgba(108, 117, 125, 0.3);
            border-left-color: #6c757d;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            vertical-align: middle;
          }

          @media (max-width: 768px) {
            .fighter-info-container {
              flex-direction: column;
              text-align: center;
            }
            
            .fighter-details {
              text-align: center;
            }
            
            .result-title {
              font-size: 2rem;
            }
            
            .fighter-name {
              font-size: 1.8rem;
            }
            
            .winner-name {
              font-size: 2rem;
            }

            .hint-meta {
              flex-direction: column;
              gap: 10px;
            }

            .answer-header {
              flex-direction: column;
              gap: 15px;
            }

            .feature-text {
              font-size: 1.4rem;
            }

            .hint-title, .answer-title {
              font-size: 1.4rem;
            }
          }
          
          /* „É≠„Éº„Éá„Ç£„É≥„Ç∞Áä∂ÊÖã„ÅÆ„Éú„Çø„É≥„Çπ„Çø„Ç§„É´ */
          .loading {
            position: relative;
            pointer-events: none;
            opacity: 0.8;
          }
          
          .loading .btn-text {
            opacity: 0;
          }
          
          .loading .btn-icon,
          .loading .pass-icon {
            opacity: 0;
          }
          
          .loading-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.9rem;
            font-weight: 500;
            white-space: nowrap;
            color: white;
          }
          
          .loading-dots {
            display: inline-block;
          }
          
          .loading-dots span {
            animation: dot-flashing 1.4s infinite linear alternate;
            animation-delay: calc(var(--delay) * 0.2s);
          }
          
          @keyframes dot-flashing {
            0% {
              opacity: 0.2;
            }
            50%, 100% {
              opacity: 1;
            }
          }

          /* Êé•Á∂öÁä∂Ê≥ÅË°®Á§∫„ÅÆ„Çπ„Çø„Ç§„É´ */
          #connection-status {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid rgba(255,255,255,0.2);
          }

          .connection-info {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
          }

          .connection-label {
            color: #666;
          }

          #connected-count {
            color: #28a745;
            font-weight: bold;
          }

          .participant-waiting {
            text-align: center;
          }

          #participant-connection-status .badge {
            font-size: 0.9rem;
            padding: 8px 12px;
          }

          #start-button-container {
            text-align: center;
            margin-top: 20px;
          }

          #start-game-btn {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
          }

          #start-game-btn:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
          }

          #start-game-btn:disabled {
            opacity: 0.7;
          }

          /* „É™„É≠„Éº„Éâ„Éú„Çø„É≥„ÅÆ„Çπ„Çø„Ç§„É´ */
          .reload-button-container {
            border-top: 1px solid rgba(255,255,255,0.3);
            padding-top: 15px;
          }

          #reload-btn {
            transition: all 0.3s ease;
            border: 2px solid #007bff;
            background: transparent;
          }

          #reload-btn:hover {
            background: #007bff;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,123,255,0.3);
          }

          #reload-btn .btn-icon {
            display: inline-block;
            margin-right: 5px;
            transition: transform 0.3s ease;
          }

          #reload-btn:hover .btn-icon {
            transform: rotate(180deg);
          }

          .auto-reload-info {
            opacity: 0.8;
          }

          #countdown {
            font-weight: bold;
            color: #007bff;
          }
        </style>

<script>
// „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„Åß„Éú„Çø„É≥„Çí‰øùÊåÅ
let currentSubmitButton = null;
let currentPassButton = null;

// „É≠„Éº„Éá„Ç£„É≥„Ç∞Áä∂ÊÖã„ÅÆÂà∂Âæ°Èñ¢Êï∞Ôºà„Ç∞„É≠„Éº„Éê„É´Ôºâ
function setButtonLoading(button, message) {
  button.classList.add('loading');
  button.disabled = true;
  
  // „É≠„Éº„Éá„Ç£„É≥„Ç∞„ÉÜ„Ç≠„Çπ„Éà„ÇíËøΩÂä†Ôºà„Éâ„ÉÉ„ÉàÈÉ®ÂàÜ„ÅØÂàÜÈõ¢Ôºâ
  const loadingText = document.createElement('div');
  loadingText.className = 'loading-text';
  
  // „ÉÜ„Ç≠„Çπ„Éà„Çí„Äå‰ªñ„ÅÆ‰∫∫„ÇíÂæÖÊ©ü‰∏≠„Äç„Å®„Äå...„Äç„Å´ÂàÜÂâ≤
  const textPart = message.replace('...', '');
  const dotsHtml = `
    <span class="loading-dots">
      <span style="--delay: 0">.</span>
      <span style="--delay: 1">.</span>
      <span style="--delay: 2">.</span>
    </span>
  `;
  
  loadingText.innerHTML = textPart + dotsHtml;
  button.appendChild(loadingText);
}

function removeButtonLoading(button) {
  if (!button) return;
  button.classList.remove('loading');
  button.disabled = false;
  
  // „É≠„Éº„Éá„Ç£„É≥„Ç∞„ÉÜ„Ç≠„Çπ„Éà„ÇíÂâäÈô§
  const loadingText = button.querySelector('.loading-text');
  if (loadingText) loadingText.remove();
}

// ÂÖ®„Å¶„ÅÆ„Éú„Çø„É≥„ÅÆ„É≠„Éº„Éá„Ç£„É≥„Ç∞Áä∂ÊÖã„ÇíËß£Èô§
function clearAllButtonLoading() {
  if (currentSubmitButton) {
    removeButtonLoading(currentSubmitButton);
  }
  if (currentPassButton) {
    removeButtonLoading(currentPassButton);
  }
}

function initializeQuizAutocomplete() {
  console.log('DOMContentLoaded fired');
  
  const searchInput = document.getElementById('fighter-search');
  const suggestionsDiv = document.getElementById('fighter-suggestions');
  const fighterIdInput = document.getElementById('fighter-id');
  const submitButton = document.getElementById('submit-answer');
  
  // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„Å´Ë®≠ÂÆö
  currentSubmitButton = submitButton;
  
  console.log('Elements found:', {
    searchInput: !!searchInput,
    suggestionsDiv: !!suggestionsDiv,
    fighterIdInput: !!fighterIdInput,
    submitButton: !!submitButton
  });
  
  if (searchInput && suggestionsDiv && fighterIdInput && submitButton) {
    console.log('All elements found, setting up autocomplete');
    
    searchInput.addEventListener('input', function() {
      const query = this.value;
      
      if (query.length < 2) {
        suggestionsDiv.innerHTML = '';
        fighterIdInput.value = '';
        submitButton.disabled = true;
        return;
      }
      
      fetch(`/fighters.json?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(fighters => {
          suggestionsDiv.innerHTML = '';
          
          fighters.slice(0, 5).forEach(fighter => {
            const item = document.createElement('a');
            item.href = '#';
            item.className = 'list-group-item list-group-item-action';
            item.textContent = fighter.display_name;
            item.dataset.fighterId = fighter.id;
            
            item.addEventListener('click', function(e) {
              e.preventDefault();
              searchInput.value = fighter.full_name;
              fighterIdInput.value = fighter.id;
              submitButton.disabled = false;
              submitButton.removeAttribute('disabled');
              suggestionsDiv.innerHTML = '';
              console.log('Fighter selected:', fighter.display_name, 'ID:', fighter.id);
            });
            
            suggestionsDiv.appendChild(item);
          });
        });
    });
  }
  
  // „Éï„Ç©„Éº„É†ÈÄÅ‰ø°„ÇíÁ¢∫ÂÆü„Å´„Åô„Çã
  const form = document.getElementById('answer-form');
  const submitBtn = document.getElementById('submit-answer');
  
  if (form && submitBtn) {
    console.log('Form and submit button found');
    
    form.addEventListener('submit', function(e) {
      e.preventDefault(); // ÈÄöÂ∏∏„ÅÆÈÄÅ‰ø°„ÇíÈò≤„Åê
      console.log('Form submit event triggered');
      const fighterIdValue = document.getElementById('fighter-id').value;
      console.log('Fighter ID:', fighterIdValue);
      
      if (!fighterIdValue) {
        alert('ÈÅ∏Êâã„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
        return false;
      }
      
      console.log('Submitting via fetch...');
      
      // „É≠„Éº„Éá„Ç£„É≥„Ç∞Áä∂ÊÖã„Å´„Åô„Çã
      setButtonLoading(submitButton, '‰ªñ„ÅÆ‰∫∫„ÇíÂæÖÊ©ü‰∏≠...');
      
      // fetch„ÅßPOST„É™„ÇØ„Ç®„Çπ„Éà„ÇíÈÄÅ‰ø°
      const token = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
      const formData = new FormData();
      formData.append('fighter_id', fighterIdValue);
      
      fetch('<%= submit_answer_quiz_session_path(@quiz_session) %>', {
        method: 'POST',
        body: formData,
        headers: {
          'X-CSRF-Token': token,
          'X-Requested-With': 'XMLHttpRequest',
          'Accept': 'application/json'
        }
      }).then(response => {
        if (response.ok) {
          return response.json();
        } else {
          throw new Error('Request failed');
        }
      }).then(data => {
        console.log('Success:', data);
        // ÊòéÁ§∫ÁöÑ„Å´„É™„É≠„Éº„Éâ„ÅåÂøÖË¶Å„Å™Â†¥Âêà„ÅÆ„Åø„É™„É≠„Éº„Éâ
        if (data.redirect === true) {
          window.location.reload();
        }
        // „É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
        if (data.message) {
          showMessage(data.message);
        }
        // „É≠„Éº„Éá„Ç£„É≥„Ç∞Áä∂ÊÖã„ÅØÊ¨°„ÅÆ„Éí„É≥„Éà/ÁµêÊûú„Åæ„ÅßÁ∂≠ÊåÅ
      }).catch(error => {
        console.error('Error:', error);
        // „Ç®„É©„ÉºÊôÇ„ÅÆ„Åø„É≠„Éº„Éá„Ç£„É≥„Ç∞Áä∂ÊÖã„ÇíËß£Èô§
        removeButtonLoading(submitButton);
        alert('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ');
      });
    });
    
    // „Éë„Çπ„Éú„Çø„É≥„ÅÆAJAXÂá¶ÁêÜ
    const passBtn = document.getElementById('pass-btn');
    currentPassButton = passBtn; // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„Å´Ë®≠ÂÆö
    if (passBtn) {
      passBtn.addEventListener('click', function() {
        // „É≠„Éº„Éá„Ç£„É≥„Ç∞Áä∂ÊÖã„Å´„Åô„Çã
        setButtonLoading(passBtn, '‰ªñ„ÅÆ‰∫∫„ÇíÂæÖÊ©ü‰∏≠...');
        
        const token = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        
        fetch('<%= pass_quiz_session_path(@quiz_session) %>', {
          method: 'PATCH',
          headers: {
            'X-CSRF-Token': token,
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json',
            'Content-Type': 'application/json'
          }
        }).then(response => {
          if (response.ok) {
            return response.json();
          } else {
            throw new Error('Request failed');
          }
        }).then(data => {
          console.log('Pass Success:', data);
          // AJAX„É¨„Çπ„Éù„É≥„Çπ„ÅÆÂ†¥Âêà„ÅØ„É™„É≠„Éº„Éâ„Åó„Å™„ÅÑ
          if (data.redirect !== false) {
            window.location.reload();
          }
          // „É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
          if (data.message) {
            showMessage(data.message);
          }
          // „É≠„Éº„Éá„Ç£„É≥„Ç∞Áä∂ÊÖã„ÅØÊ¨°„ÅÆ„Éí„É≥„Éà/ÁµêÊûú„Åæ„ÅßÁ∂≠ÊåÅ
        }).catch(error => {
          console.error('Pass Error:', error);
          // „Ç®„É©„ÉºÊôÇ„ÅÆ„Åø„É≠„Éº„Éá„Ç£„É≥„Ç∞Áä∂ÊÖã„ÇíËß£Èô§
          removeButtonLoading(passBtn);
          alert('„Éë„ÇπÂá¶ÁêÜ„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ');
        });
      });
    }
  } else {
    console.log('Some elements not found');
  }

  // „É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫Ê©üËÉΩ
  function showMessage(message) {
    // Êó¢Â≠ò„ÅÆÈÄöÁü•„ÇíÂâäÈô§
    const existingNotice = document.querySelector('.ajax-notice');
    if (existingNotice) {
      existingNotice.remove();
    }
    
    // Êñ∞„Åó„ÅÑÈÄöÁü•„Çí‰ΩúÊàê
    const notice = document.createElement('div');
    notice.className = 'ajax-notice';
    notice.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #d4edda; color: #155724; padding: 15px; border-radius: 5px; z-index: 1000; max-width: 300px;';
    notice.textContent = message;
    
    document.body.appendChild(notice);
    
    // 3ÁßíÂæå„Å´Ëá™ÂãïÂâäÈô§
    setTimeout(() => {
      notice.remove();
    }, 3000);
  }
}

// ActionCable„Å´„Çà„Çã„É™„Ç¢„É´„Çø„Ç§„É†Êõ¥Êñ∞
function setupQuizSubscription() {
  if (!window.App || !window.App.cable) {
    console.error('ActionCable not available for quiz, retrying in 1 second...');
    setTimeout(setupQuizSubscription, 1000);
    return;
  }
  
  const quizSessionId = <%= @quiz_session.id %>;
  
  console.log('Setting up ActionCable subscription for quiz session:', quizSessionId);
  
  window.App.cable.subscriptions.create({
    channel: "QuizSessionChannel",
    quiz_session_id: quizSessionId
  }, {
    connected() {
      console.log("Connected to QuizSessionChannel");
    },
    
    disconnected() {
      console.log("Disconnected from QuizSessionChannel");
    },
    
    received(data) {
      console.log("Received data:", data);
      
      switch(data.type) {
        case 'participant_answered':
          // ÂèÇÂä†ËÄÖ„ÅåÂõûÁ≠î„Åó„ÅüÊôÇ„ÅÆÂá¶ÁêÜ
          updateParticipantStatus(data.user_id, data.status);
          break;
        case 'next_hint':
          // Ê¨°„ÅÆ„Éí„É≥„Éà„Å´ÈÄ≤„Çì„Å†ÊôÇ - „É≠„Éº„Éá„Ç£„É≥„Ç∞Ëß£Èô§„Åó„Å¶„Åã„Çâ„É™„É≠„Éº„Éâ
          clearAllButtonLoading();
          window.location.reload();
          break;
        case 'game_ended':
          // „Ç≤„Éº„É†ÁµÇ‰∫ÜÊôÇ - „É≠„Éº„Éá„Ç£„É≥„Ç∞Ëß£Èô§„Åó„Å¶„Åã„Çâ„É™„É≠„Éº„Éâ
          clearAllButtonLoading();
          window.location.reload();
          break;
        case 'session_started':
          // „Çª„ÉÉ„Ç∑„Éß„É≥ÈñãÂßãÊôÇ - „É≠„Éº„Éá„Ç£„É≥„Ç∞Ëß£Èô§„Åó„Å¶„Åã„Çâ„É™„É≠„Éº„Éâ
          clearAllButtonLoading();
          window.location.reload();
          break;
        case 'connection_updated':
          // Êé•Á∂öÁä∂Ê≥Å„ÅåÊõ¥Êñ∞„Åï„Çå„ÅüÊôÇ
          updateConnectionStatus(data);
          break;
      }
    }
  });
}

function updateParticipantStatus(userId, status) {
  // ÂèÇÂä†ËÄÖ„É™„Çπ„Éà„ÅÆÁä∂ÊÖã„ÇíÊõ¥Êñ∞
  const participantElements = document.querySelectorAll('[data-user-id="' + userId + '"]');
  participantElements.forEach(element => {
    const statusBadge = element.querySelector('.participant-status');
    if (statusBadge) {
      statusBadge.className = 'badge participant-status';
      switch(status) {
        case 'correct':
          statusBadge.classList.add('bg-success');
          statusBadge.textContent = 'Ê≠£Ëß£';
          break;
        case 'incorrect':
          statusBadge.classList.add('bg-warning');
          statusBadge.textContent = '‰∏çÊ≠£Ëß£';
          break;
        case 'passed':
          statusBadge.classList.add('bg-secondary');
          statusBadge.textContent = '„Éë„Çπ';
          break;
      }
    }
  });
}

function updateConnectionStatus(data) {
  // Êé•Á∂ö„Ç´„Ç¶„É≥„Éà„ÇíÊõ¥Êñ∞
  const connectedCountElement = document.getElementById('connected-count');
  const totalCountElement = document.getElementById('total-count');
  const progressElement = document.getElementById('connection-progress');
  const startButton = document.getElementById('start-game-btn');
  
  if (connectedCountElement) {
    connectedCountElement.textContent = data.connected_count;
  }
  
  if (totalCountElement) {
    totalCountElement.textContent = data.total_count;
  }
  
  if (progressElement && data.total_count > 0) {
    const percentage = (data.connected_count / data.total_count) * 100;
    progressElement.style.width = percentage + '%';
  }
  
  // „Çπ„Çø„Éº„Éà„Éú„Çø„É≥„ÅÆÁä∂ÊÖã„ÇíÊõ¥Êñ∞
  if (startButton) {
    if (data.all_connected && data.total_count >= 2) {
      startButton.disabled = false;
      startButton.className = 'btn btn-success btn-lg';
      startButton.querySelector('.btn-icon').textContent = 'üöÄ';
      startButton.querySelector('.btn-text').textContent = '„Ç≤„Éº„É†„ÇíÈñãÂßã';
      startButton.onclick = startGame;
    } else {
      startButton.disabled = true;
      startButton.className = 'btn btn-secondary btn-lg';
      startButton.querySelector('.btn-icon').textContent = '‚è≥';
      startButton.querySelector('.btn-text').textContent = 'ÂÖ®Âì°„ÅÆÊé•Á∂ö„ÇíÂæÖÊ©ü‰∏≠...';
      startButton.onclick = null;
    }
  }
  
  // ÂèÇÂä†ËÄÖ„ÅÆÊé•Á∂öÁä∂Ê≥Å„Éê„ÉÉ„Ç∏„ÇíÊõ¥Êñ∞
  const participantConnectionStatus = document.getElementById('participant-connection-status');
  if (participantConnectionStatus) {
    // ÁèæÂú®„ÅÆ„É¶„Éº„Ç∂„Éº„ÅåÊé•Á∂öÊ∏à„Åø„Åã„Å©„ÅÜ„Åã„ÅØ„ÄÅWebSocket„ÅåÂãï‰Ωú„Åó„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÊé•Á∂öÊ∏à„Åø„Å®Âà§Êñ≠
    const badge = participantConnectionStatus.querySelector('.badge');
    if (badge) {
      badge.className = 'badge bg-success';
      badge.textContent = '‚úì Êé•Á∂öÊ∏à„Åø';
    }
  }
}

function startGame() {
  const startButton = document.getElementById('start-game-btn');
  if (startButton) {
    setButtonLoading(startButton, 'ÈñãÂßã‰∏≠...');
    
    const token = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    
    fetch('<%= start_quiz_session_path(@quiz_session) %>', {
      method: 'PATCH',
      headers: {
        'X-CSRF-Token': token,
        'X-Requested-With': 'XMLHttpRequest',
        'Accept': 'application/json',
        'Content-Type': 'application/json'
      }
    }).then(response => {
      if (response.ok) {
        return response.json();
      } else {
        throw new Error('Request failed');
      }
    }).then(data => {
      console.log('Start game response:', data);
      if (data.status === 'success') {
        // ÊàêÂäü„ÅÆÂ†¥Âêà„ÅØWebSocket„Åß„Çª„ÉÉ„Ç∑„Éß„É≥ÈñãÂßã„ÅÆÈÄöÁü•„ÅåÊù•„Çã„ÅÆ„Åß„Åù„Åì„Åß„É™„É≠„Éº„Éâ
        showMessage(data.message);
      } else if (data.status === 'waiting') {
        // „Åæ„Å†ÂÖ®Âì°Êé•Á∂ö„Åó„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà
        removeButtonLoading(startButton);
        showMessage(data.message);
      } else {
        // „Ç®„É©„Éº„ÅÆÂ†¥Âêà
        removeButtonLoading(startButton);
        showMessage(data.message || '„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ');
      }
    }).catch(error => {
      console.error('Start game error:', error);
      removeButtonLoading(startButton);
      alert('„Ç≤„Éº„É†ÈñãÂßã„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ');
    });
  }
}

// ÂæÖÊ©üÁîªÈù¢„Åß„ÅÆËá™Âãï„É™„É≠„Éº„ÉâÊ©üËÉΩ
function setupAutoReload() {
  // ÂæÖÊ©üÁîªÈù¢„Åã„Å©„ÅÜ„Åã„ÇíÁ¢∫Ë™ç
  const isWaitingState = <%= @quiz_session.waiting? ? 'true' : 'false' %>;
  if (!isWaitingState) return;
  
  let countdown = 10;
  const countdownElement = document.getElementById('countdown');
  const autoReloadInfo = document.getElementById('auto-reload-info');
  
  if (!countdownElement || !autoReloadInfo) return;
  
  const countdownTimer = setInterval(function() {
    countdown--;
    countdownElement.textContent = countdown;
    
    if (countdown <= 0) {
      clearInterval(countdownTimer);
      location.reload();
    }
  }, 1000);
  
  // ÊâãÂãï„É™„É≠„Éº„Éâ„Éú„Çø„É≥„ÅåÊäº„Åï„Çå„ÅüÂ†¥Âêà„ÅØ„Çø„Ç§„Éû„Éº„Çí„ÇØ„É™„Ç¢
  const reloadBtn = document.getElementById('reload-btn');
  if (reloadBtn) {
    reloadBtn.addEventListener('click', function() {
      clearInterval(countdownTimer);
    });
  }
  
  // „Ç≤„Éº„É†ÈñãÂßã„Éú„Çø„É≥„ÅåÊäº„Åï„Çå„ÅüÂ†¥Âêà„ÇÇ„Çø„Ç§„Éû„Éº„Çí„ÇØ„É™„Ç¢
  const startBtn = document.getElementById('start-game-btn');
  if (startBtn) {
    startBtn.addEventListener('click', function() {
      clearInterval(countdownTimer);
    });
  }
}

// DOMContentLoaded„Åæ„Åü„ÅØÂç≥Â∫ß„Å´ÂÆüË°å
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', function() {
    initializeQuizAutocomplete();
    setupQuizSubscription();
    setupAutoReload();
  });
} else {
  // DOM„ÅØÊó¢„Å´Ë™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Çã
  initializeQuizAutocomplete();
  setupQuizSubscription();
  setupAutoReload();
}
</script>