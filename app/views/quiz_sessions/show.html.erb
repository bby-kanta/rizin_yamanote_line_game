<div class="container">
  <div class="row">
    <div class="col-md-8">
      <h1 class="mb-4">
        ğŸ” ã‚¯ã‚¤ã‚º #<%= @quiz_session.id %>
        <% if @quiz_session.waiting? %>
          <span class="badge bg-warning text-dark">å¾…æ©Ÿä¸­</span>
        <% elsif @quiz_session.started? %>
          <span class="badge bg-success">ãƒ—ãƒ¬ã‚¤ä¸­</span>
        <% else %>
          <span class="badge bg-secondary">çµ‚äº†</span>
        <% end %>
      </h1>

      <!-- ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã«å¿œã˜ãŸè¡¨ç¤º -->
      <% if @quiz_session.waiting? %>
        <div class="alert alert-info">
          <h5 class="alert-heading">â³ ã‚²ãƒ¼ãƒ é–‹å§‹ã‚’å¾…ã£ã¦ã„ã¾ã™</h5>
          <p>ä½œæˆè€…: <%= @quiz_session.creator.name %></p>
          <% if @quiz_session.creator == current_user && @quiz_session.participants.count >= 2 %>
            <%= button_to "ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹", start_quiz_session_path(@quiz_session), method: :patch, class: "btn btn-success btn-lg" %>
          <% elsif @quiz_session.creator == current_user %>
            <p class="text-muted">ä»–ã®å‚åŠ è€…ã‚’å¾…ã£ã¦ã„ã¾ã™...ï¼ˆæœ€ä½2äººå¿…è¦ï¼‰</p>
          <% elsif @can_join %>
            <%= button_to "å‚åŠ ã™ã‚‹", join_quiz_session_path(@quiz_session), method: :patch, class: "btn btn-primary btn-lg" %>
          <% elsif @participant %>
            <p>å‚åŠ æ¸ˆã¿ - ã‚²ãƒ¼ãƒ é–‹å§‹ã‚’å¾…ã£ã¦ã„ã¾ã™</p>
          <% end %>
        </div>

      <% elsif @quiz_session.started? %>
        <div class="card mb-4">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0">ç¾åœ¨ã®ãƒ’ãƒ³ãƒˆ #<%= @quiz_session.current_hint_index + 1 %></h5>
          </div>
          <div class="card-body" id="current-hint">
            <% if @current_hint %>
              <div class="alert alert-light">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <span class="badge bg-secondary me-2"><%= @current_hint.category_name %></span>
                    <span class="badge bg-info">ãƒ¬ãƒ™ãƒ« <%= @current_hint.level %></span>
                  </div>
                </div>
                <h4 class="mt-3"><%= @current_hint.feature %></h4>
              </div>
            <% else %>
              <p class="text-muted">ãƒ’ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</p>
            <% end %>
          </div>
        </div>

        <!-- å›ç­”ãƒ•ã‚©ãƒ¼ãƒ  -->
        <% if @participant && !@participant.answered? && !@quiz_session.quiz_answers.where(user: current_user, hint_index: @quiz_session.current_hint_index).exists? %>
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0">å›ç­”ã™ã‚‹</h5>
            </div>
            <div class="card-body">
              <form action="<%= submit_answer_quiz_session_path(@quiz_session) %>" method="post" id="answer-form" data-turbo="false" data-method="post">
                <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
                <input type="hidden" name="_method" value="post">
                <div class="mb-3">
                  <label for="fighter_name" class="form-label">é¸æ‰‹åï¼ˆã²ã‚‰ãŒãªï¼‰</label>
                  <input type="text" name="fighter_name" class="form-control" id="fighter-search" placeholder="ã²ã‚‰ãŒãªã§å…¥åŠ›">
                  <div id="fighter-suggestions" class="list-group mt-2"></div>
                </div>
                <input type="hidden" name="fighter_id" id="fighter-id">
                <div class="d-flex gap-2 align-items-center">
                  <input type="submit" value="å›ç­”" class="btn btn-primary" id="submit-answer" disabled>
                  <span class="text-muted">ãƒŸã‚¹: <%= @participant.miss_count %>å›</span>
                </div>
              </form>
              
              <!-- ãƒ‘ã‚¹ãƒœã‚¿ãƒ³ã¯ãƒ•ã‚©ãƒ¼ãƒ å¤–ã«é…ç½® -->
              <div class="mt-3 text-center">
                <%= button_to "ãƒ‘ã‚¹", pass_quiz_session_path(@quiz_session), method: :patch, class: "btn btn-secondary", data: { turbo: false } %>
              </div>
            </div>
          </div>
        <% elsif @participant && @participant.answered? %>
          <div class="alert alert-success">
            <h5 class="alert-heading">âœ… æ­£è§£ã§ã™ï¼</h5>
            <p>ä»–ã®å‚åŠ è€…ã®å›ç­”ã‚’å¾…ã£ã¦ã„ã¾ã™...</p>
          </div>
        <% elsif @participant && @quiz_session.quiz_answers.where(user: current_user, hint_index: @quiz_session.current_hint_index).exists? %>
          <% current_answer = @quiz_session.quiz_answers.where(user: current_user, hint_index: @quiz_session.current_hint_index).last %>
          <div class="alert alert-<%= current_answer.passed? ? 'secondary' : 'warning' %>">
            <% if current_answer.passed? %>
              <h5 class="alert-heading">â­ï¸ ãƒ‘ã‚¹ã—ã¾ã—ãŸ</h5>
              <p>ä»–ã®å‚åŠ è€…ã®å›ç­”ã‚’å¾…ã£ã¦ã„ã¾ã™...</p>
            <% else %>
              <h5 class="alert-heading">âŒ ä¸æ­£è§£ã§ã—ãŸ</h5>
              <p>ä»–ã®å‚åŠ è€…ã®å›ç­”ã‚’å¾…ã£ã¦ã„ã¾ã™...</p>
            <% end %>
          </div>
        <% end %>

      <% else %>
        <!-- çµ‚äº†æ™‚ã®çµæœè¡¨ç¤º -->
        <div class="card mb-4">
          <div class="card-header bg-success text-white">
            <h5 class="mb-0">ğŸŠ ã‚¯ã‚¤ã‚ºçµ‚äº†ï¼</h5>
          </div>
          <div class="card-body">
            <h3>æ­£è§£: <%= @quiz_session.target_fighter.display_name %></h3>
            <% if @quiz_session.winner_user %>
              <h4>ğŸ† å‹è€…: <%= @quiz_session.winner_user.name %></h4>
            <% else %>
              <% max_points = @quiz_session.quiz_participants.maximum(:points) || 0 %>
              <% top_count = @quiz_session.quiz_participants.where(points: max_points).count %>
              <% if top_count > 1 %>
                <h4>ğŸ¤ åŒç‚¹ã®ãŸã‚å‹è€…ãªã—</h4>
              <% else %>
                <h4>âŒ å‹è€…ãªã—</h4>
              <% end %>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>

    <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼šå‚åŠ è€…ãƒªã‚¹ãƒˆ -->
    <div class="col-md-4">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">ğŸ‘¥ å‚åŠ è€… (<%= @participants.count %>äºº)</h5>
        </div>
        <div class="card-body">
          <ul class="list-group">
            <% @participants.each do |participant| %>
              <li class="list-group-item d-flex justify-content-between align-items-center" data-user-id="<%= participant.user_id %>">
                <div>
                  <%= participant.user.name %>
                  <% if participant.is_winner %>
                    <span class="badge bg-warning text-dark ms-2">ğŸ†</span>
                  <% end %>
                </div>
                <div>
                  <% if participant.answered? %>
                    <span class="badge bg-success participant-status">æ­£è§£</span>
                  <% elsif @quiz_session.started? %>
                    <% current_hint_answer = @current_hint_answers&.dig(participant.user_id) %>
                    <% if current_hint_answer %>
                      <% if current_hint_answer.passed? %>
                        <span class="badge bg-secondary participant-status">ãƒ‘ã‚¹</span>
                      <% else %>
                        <span class="badge bg-warning participant-status">ä¸æ­£è§£</span>
                      <% end %>
                    <% else %>
                      <span class="badge bg-secondary participant-status">è€ƒãˆä¸­...</span>
                    <% end %>
                  <% end %>
                  <% if @quiz_session.ended? %>
                    <span class="badge bg-primary"><%= participant.points %>pt</span>
                  <% end %>
                </div>
              </li>
            <% end %>
          </ul>
        </div>
      </div>

      <% if @quiz_session.ended? %>
        <div class="card mt-3">
          <div class="card-header">
            <h5 class="mb-0">ğŸ“Š æœ€çµ‚çµæœ</h5>
          </div>
          <div class="card-body">
            <ol class="list-group list-group-numbered">
              <% @participants.by_points.each_with_index do |participant, index| %>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <div>
                    <%= participant.user.name %>
                  </div>
                  <div>
                    <span class="badge bg-primary"><%= participant.points %>pt</span>
                    <span class="badge bg-danger">ãƒŸã‚¹: <%= participant.miss_count %>å›</span>
                  </div>
                </li>
              <% end %>
            </ol>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
function initializeQuizAutocomplete() {
  console.log('DOMContentLoaded fired');
  
  const searchInput = document.getElementById('fighter-search');
  const suggestionsDiv = document.getElementById('fighter-suggestions');
  const fighterIdInput = document.getElementById('fighter-id');
  const submitButton = document.getElementById('submit-answer');
  
  console.log('Elements found:', {
    searchInput: !!searchInput,
    suggestionsDiv: !!suggestionsDiv,
    fighterIdInput: !!fighterIdInput,
    submitButton: !!submitButton
  });
  
  if (searchInput && suggestionsDiv && fighterIdInput && submitButton) {
    console.log('All elements found, setting up autocomplete');
    
    searchInput.addEventListener('input', function() {
      const query = this.value;
      
      if (query.length < 2) {
        suggestionsDiv.innerHTML = '';
        fighterIdInput.value = '';
        submitButton.disabled = true;
        return;
      }
      
      fetch(`/fighters.json?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(fighters => {
          suggestionsDiv.innerHTML = '';
          
          fighters.slice(0, 5).forEach(fighter => {
            const item = document.createElement('a');
            item.href = '#';
            item.className = 'list-group-item list-group-item-action';
            item.textContent = fighter.display_name;
            item.dataset.fighterId = fighter.id;
            
            item.addEventListener('click', function(e) {
              e.preventDefault();
              searchInput.value = fighter.full_name_hiragana;
              fighterIdInput.value = fighter.id;
              submitButton.disabled = false;
              submitButton.removeAttribute('disabled');
              suggestionsDiv.innerHTML = '';
              console.log('Fighter selected:', fighter.display_name, 'ID:', fighter.id);
            });
            
            suggestionsDiv.appendChild(item);
          });
        });
    });
  }
  
  // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‚’ç¢ºå®Ÿã«ã™ã‚‹
  const form = document.getElementById('answer-form');
  const submitBtn = document.getElementById('submit-answer');
  
  if (form && submitBtn) {
    console.log('Form and submit button found');
    
    form.addEventListener('submit', function(e) {
      e.preventDefault(); // é€šå¸¸ã®é€ä¿¡ã‚’é˜²ã
      console.log('Form submit event triggered');
      const fighterIdValue = document.getElementById('fighter-id').value;
      console.log('Fighter ID:', fighterIdValue);
      
      if (!fighterIdValue) {
        alert('é¸æ‰‹ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
        return false;
      }
      
      console.log('Submitting via fetch...');
      
      // fetchã§POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
      const token = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
      const formData = new FormData();
      formData.append('fighter_id', fighterIdValue);
      
      fetch('<%= submit_answer_quiz_session_path(@quiz_session) %>', {
        method: 'POST',
        body: formData,
        headers: {
          'X-CSRF-Token': token,
          'X-Requested-With': 'XMLHttpRequest',
          'Accept': 'application/json'
        }
      }).then(response => {
        if (response.ok) {
          return response.json();
        } else {
          throw new Error('Request failed');
        }
      }).then(data => {
        console.log('Success:', data);
        window.location.reload();
      }).catch(error => {
        console.error('Error:', error);
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
      });
    });
  } else {
    console.log('Some elements not found');
  }
}

// ActionCableã«ã‚ˆã‚‹ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
function setupQuizSubscription() {
  const quizSessionId = <%= @quiz_session.id %>;
  
  console.log('Setting up ActionCable subscription for quiz session:', quizSessionId);
  
  App.cable.subscriptions.create({
    channel: "QuizSessionChannel",
    quiz_session_id: quizSessionId
  }, {
    connected() {
      console.log("Connected to QuizSessionChannel");
    },
    
    disconnected() {
      console.log("Disconnected from QuizSessionChannel");
    },
    
    received(data) {
      console.log("Received data:", data);
      
      switch(data.type) {
        case 'participant_answered':
          // å‚åŠ è€…ãŒå›ç­”ã—ãŸæ™‚ã®å‡¦ç†
          updateParticipantStatus(data.user_id, data.status);
          break;
        case 'next_hint':
          // æ¬¡ã®ãƒ’ãƒ³ãƒˆã«é€²ã‚“ã æ™‚
          window.location.reload();
          break;
        case 'game_ended':
          // ã‚²ãƒ¼ãƒ çµ‚äº†æ™‚
          window.location.reload();
          break;
        case 'session_started':
          // ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹æ™‚
          window.location.reload();
          break;
      }
    }
  });
}

function updateParticipantStatus(userId, status) {
  // å‚åŠ è€…ãƒªã‚¹ãƒˆã®çŠ¶æ…‹ã‚’æ›´æ–°
  const participantElements = document.querySelectorAll('[data-user-id="' + userId + '"]');
  participantElements.forEach(element => {
    const statusBadge = element.querySelector('.participant-status');
    if (statusBadge) {
      statusBadge.className = 'badge participant-status';
      switch(status) {
        case 'correct':
          statusBadge.classList.add('bg-success');
          statusBadge.textContent = 'æ­£è§£';
          break;
        case 'incorrect':
          statusBadge.classList.add('bg-warning');
          statusBadge.textContent = 'ä¸æ­£è§£';
          break;
        case 'passed':
          statusBadge.classList.add('bg-secondary');
          statusBadge.textContent = 'ãƒ‘ã‚¹';
          break;
      }
    }
  });
}

// DOMContentLoadedã¾ãŸã¯å³åº§ã«å®Ÿè¡Œ
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', function() {
    initializeQuizAutocomplete();
    setupQuizSubscription();
  });
} else {
  // DOMã¯æ—¢ã«èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹
  initializeQuizAutocomplete();
  setupQuizSubscription();
}
</script>